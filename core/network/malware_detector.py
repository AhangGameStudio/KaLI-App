# 恶意软件检测模块
# 基于特征和行为分析

import os
import hashlib
import json
import requests

class MalwareDetector:
    def __init__(self):
        self.signature_db = {}
        self.behavior_rules = []
        self.scan_history = []
        
        # 加载默认规则
        self.load_default_rules()
    
    def load_default_rules(self):
        """加载默认的恶意软件检测规则"""
        # 常见恶意软件行为规则
        self.behavior_rules = [
            {
                'name': '可疑网络连接',
                'pattern': lambda proc: any(conn['ip'].startswith('192.168.') for conn in proc.get('connections', [])),
                'severity': 'medium'
            },
            {
                'name': '敏感文件访问',
                'pattern': lambda proc: any(file.startswith('C:\\Windows\\System32') for file in proc.get('files', [])),
                'severity': 'high'
            },
            {
                'name': '自启动项修改',
                'pattern': lambda proc: any('Startup' in path for path in proc.get('registry', [])),
                'severity': 'high'
            }
        ]
    
    def load_signature_db(self, db_path=None):
        """加载特征数据库"""
        if db_path and os.path.exists(db_path):
            try:
                with open(db_path, 'r') as f:
                    self.signature_db = json.load(f)
            except Exception as e:
                print(f"加载特征数据库失败: {e}")
        else:
            # 使用内置的简单特征库
            self.signature_db = {
                'known_malware': {
                    'e4d909c290d0fb1ca068ffaddf22cbd0': 'Malware.A',
                    '5d41402abc4b2a76b9719d911017c592': 'Malware.B'
                }
            }
    
    def scan_file(self, file_path):
        """扫描单个文件"""
        if not os.path.exists(file_path):
            return {'status': 'error', 'message': '文件不存在'}
        
        try:
            # 计算文件哈希
            file_hash = self.calculate_hash(file_path)
            
            # 检查哈希是否在特征库中
            detection = None
            for malware_type, hashes in self.signature_db.items():
                if file_hash in hashes:
                    detection = {
                        'type': malware_type,
                        'name': hashes[file_hash]
                    }
                    break
            
            # 记录扫描历史
            scan_result = {
                'file': file_path,
                'hash': file_hash,
                'detection': detection,
                'timestamp': os.path.getmtime(file_path)
            }
            self.scan_history.append(scan_result)
            
            return scan_result
            
        except Exception as e:
            return {'status': 'error', 'message': str(e)}
    
    def scan_directory(self, directory, recursive=True):
        """扫描目录"""
        if not os.path.exists(directory):
            return {'status': 'error', 'message': '目录不存在'}
        
        results = []
        files_scanned = 0
        detections = 0
        
        for root, dirs, files in os.walk(directory):
            for file in files:
                file_path = os.path.join(root, file)
                result = self.scan_file(file_path)
                results.append(result)
                files_scanned += 1
                
                if result.get('detection'):
                    detections += 1
            
            if not recursive:
                break
        
        return {
            'status': 'completed',
            'files_scanned': files_scanned,
            'detections': detections,
            'results': results
        }
    
    def analyze_process(self, process_info):
        """分析进程行为"""
        suspicious_behaviors = []
        
        for rule in self.behavior_rules:
            try:
                if rule['pattern'](process_info):
                    suspicious_behaviors.append({
                        'rule': rule['name'],
                        'severity': rule['severity']
                    })
            except Exception:
                pass
        
        return {
            'process': process_info.get('name', 'Unknown'),
            'suspicious_behaviors': suspicious_behaviors,
            'risk_level': self.calculate_risk_level(suspicious_behaviors)
        }
    
    def calculate_hash(self, file_path, hash_type='md5'):
        """计算文件哈希值"""
        hash_obj = hashlib.new(hash_type)
        
        with open(file_path, 'rb') as f:
            while chunk := f.read(8192):
                hash_obj.update(chunk)
        
        return hash_obj.hexdigest()
    
    def calculate_risk_level(self, behaviors):
        """根据行为计算风险等级"""
        if not behaviors:
            return 'low'
        
        high_count = sum(1 for b in behaviors if b['severity'] == 'high')
        medium_count = sum(1 for b in behaviors if b['severity'] == 'medium')
        
        if high_count >= 2:
            return 'critical'
        elif high_count >= 1:
            return 'high'
        elif medium_count >= 2:
            return 'medium'
        else:
            return 'low'
    
    def update_signature_db(self, api_url=None):
        """从API更新特征数据库"""
        if api_url:
            try:
                response = requests.get(api_url, timeout=10)
                if response.status_code == 200:
                    new_signatures = response.json()
                    self.signature_db.update(new_signatures)
                    return True
            except Exception as e:
                print(f"更新特征数据库失败: {e}")
        
        return False

# 示例用法
if __name__ == "__main__":
    detector = MalwareDetector()
    
    # 扫描文件示例
    test_file = __file__
    result = detector.scan_file(test_file)
    print(f"文件扫描结果: {result}")
    
    # 分析进程示例
    test_process = {
        'name': 'test.exe',
        'connections': [{'ip': '192.168.1.100', 'port': 8080}],
        'files': ['C:\\Windows\\System32\\kernel32.dll'],
        'registry': ['HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run']
    }
    
    behavior_result = detector.analyze_process(test_process)
    print(f"进程行为分析: {behavior_result}")