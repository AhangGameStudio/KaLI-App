# 安全漏洞扫描模块
# 实现系统和网络漏洞扫描功能

import subprocess
import os
import re
import platform
import json
from datetime import datetime

class VulnerabilityScanner:
    def __init__(self):
        self.vulnerability_database = {}
        self.scan_history = []
        self.load_vulnerability_db()
    
    def load_vulnerability_db(self):
        """加载漏洞数据库"""
        # 内置的简单漏洞数据库
        self.vulnerability_database = {
            'CVE-2021-44228': {
                'name': 'Log4Shell',
                'description': 'Apache Log4j 远程代码执行漏洞',
                'severity': 'critical',
                'affected_versions': ['2.0-beta9', '2.14.1'],
                'check_method': 'file_scan',
                'pattern': 'log4j-core'
            },
            'CVE-2023-21771': {
                'name': 'Windows Kernel Elevation of Privilege Vulnerability',
                'description': 'Windows 内核权限提升漏洞',
                'severity': 'high',
                'affected_versions': ['Windows 10', 'Windows 11', 'Windows Server 2019', 'Windows Server 2022'],
                'check_method': 'system_version'
            },
            'CVE-2022-21907': {
                'name': 'Windows Network File System Remote Code Execution Vulnerability',
                'description': 'Windows 网络文件系统远程代码执行漏洞',
                'severity': 'critical',
                'affected_versions': ['Windows Server 2019', 'Windows Server 2022'],
                'check_method': 'service_check',
                'service': 'NFS'
            }
        }
    
    def scan_system(self):
        """扫描系统漏洞"""
        results = {
            'timestamp': datetime.now().isoformat(),
            'type': 'system',
            'results': [],
            'summary': {
                'total': 0,
                'critical': 0,
                'high': 0,
                'medium': 0,
                'low': 0
            }
        }
        
        # 检查系统版本
        system_info = self.get_system_info()
        results['system_info'] = system_info
        
        # 检查系统漏洞
        for cve, info in self.vulnerability_database.items():
            if info['check_method'] == 'system_version':
                if system_info['os'] in info['affected_versions']:
                    result = {
                        'cve': cve,
                        'name': info['name'],
                        'description': info['description'],
                        'severity': info['severity'],
                        'status': 'vulnerable',
                        'details': f"Affected system: {system_info['os']} {system_info['version']}"
                    }
                    results['results'].append(result)
                    results['summary']['total'] += 1
                    results['summary'][info['severity']] += 1
        
        # 检查服务状态
        services = self.get_running_services()
        results['services'] = services
        
        for cve, info in self.vulnerability_database.items():
            if info['check_method'] == 'service_check':
                for service in services:
                    if info['service'].lower() in service['name'].lower():
                        result = {
                            'cve': cve,
                            'name': info['name'],
                            'description': info['description'],
                            'severity': info['severity'],
                            'status': 'vulnerable',
                            'details': f"Affected service: {service['name']} (Status: {service['status']})"
                        }
                        results['results'].append(result)
                        results['summary']['total'] += 1
                        results['summary'][info['severity']] += 1
        
        # 检查文件
        critical_files = self.scan_critical_files()
        results['file_scan'] = critical_files
        
        for cve, info in self.vulnerability_database.items():
            if info['check_method'] == 'file_scan':
                for file_info in critical_files:
                    if info['pattern'] in file_info['path']:
                        result = {
                            'cve': cve,
                            'name': info['name'],
                            'description': info['description'],
                            'severity': info['severity'],
                            'status': 'vulnerable',
                            'details': f"Affected file: {file_info['path']}"
                        }
                        results['results'].append(result)
                        results['summary']['total'] += 1
                        results['summary'][info['severity']] += 1
        
        # 记录扫描历史
        self.scan_history.append(results)
        
        return results
    
    def scan_network(self, target=None):
        """扫描网络漏洞"""
        results = {
            'timestamp': datetime.now().isoformat(),
            'type': 'network',
            'target': target or 'localhost',
            'results': [],
            'summary': {
                'total': 0,
                'critical': 0,
                'high': 0,
                'medium': 0,
                'low': 0
            }
        }
        
        # 检查开放端口
        open_ports = self.scan_open_ports(target)
        results['open_ports'] = open_ports
        
        # 常见服务漏洞检查
        common_vulnerabilities = {
            21: [
                {
                    'name': 'FTP Anonymous Login',
                    'severity': 'medium',
                    'description': 'FTP服务允许匿名登录'
                }
            ],
            22: [
                {
                    'name': 'SSH Weak Key',
                    'severity': 'high',
                    'description': 'SSH使用弱密钥'
                }
            ],
            80: [
                {
                    'name': 'HTTP Server Information Disclosure',
                    'severity': 'low',
                    'description': 'HTTP服务器泄露版本信息'
                }
            ],
            443: [
                {
                    'name': 'SSL/TLS Vulnerability',
                    'severity': 'high',
                    'description': 'SSL/TLS配置存在漏洞'
                }
            ]
        }
        
        for port in open_ports:
            if port in common_vulnerabilities:
                for vuln in common_vulnerabilities[port]:
                    result = {
                        'port': port,
                        'name': vuln['name'],
                        'description': vuln['description'],
                        'severity': vuln['severity'],
                        'status': 'potential',
                        'details': f"Port {port} is open, may be vulnerable to {vuln['name']}"
                    }
                    results['results'].append(result)
                    results['summary']['total'] += 1
                    results['summary'][vuln['severity']] += 1
        
        # 记录扫描历史
        self.scan_history.append(results)
        
        return results
    
    def get_system_info(self):
        """获取系统信息"""
        system_info = {
            'os': platform.system(),
            'version': platform.version(),
            'architecture': platform.architecture(),
            'machine': platform.machine()
        }
        
        if platform.system() == 'Windows':
            try:
                import wmi
                wmi_client = wmi.WMI()
                for os in wmi_client.Win32_OperatingSystem():
                    system_info['os_version'] = os.Version
                    system_info['service_pack'] = os.ServicePackMajorVersion
                    break
            except Exception:
                pass
        
        return system_info
    
    def get_running_services(self):
        """获取运行中的服务"""
        services = []
        
        try:
            if platform.system() == 'Windows':
                import psutil
                for service in psutil.win_service_iter():
                    try:
                        service_info = service.as_dict()
                        if service_info['status'] == 'running':
                            services.append({
                                'name': service_info['name'],
                                'display_name': service_info['display_name'],
                                'status': service_info['status']
                            })
                    except Exception:
                        pass
            elif platform.system() == 'Linux':
                try:
                    output = subprocess.check_output(['systemctl', 'list-units', '--type=service', '--state=running'], text=True)
                    for line in output.split('\n')[1:]:
                        if line.strip():
                            parts = line.split()
                            if len(parts) > 2:
                                services.append({
                                    'name': parts[0],
                                    'status': parts[2],
                                    'details': ' '.join(parts[3:])
                                })
                except Exception:
                    pass
        except Exception:
            pass
        
        return services
    
    def scan_critical_files(self):
        """扫描关键文件"""
        critical_files = []
        
        # 定义关键文件路径
        critical_paths = []
        
        if platform.system() == 'Windows':
            critical_paths = [
                'C:\\Windows\\System32\\',
                'C:\\Program Files\\',
                'C:\\Program Files (x86)\\'
            ]
        elif platform.system() == 'Linux':
            critical_paths = [
                '/etc/',
                '/usr/bin/',
                '/usr/sbin/'
            ]
        
        for path in critical_paths:
            if os.path.exists(path):
                try:
                    for root, dirs, files in os.walk(path):
                        for file in files[:50]:  # 限制文件数量
                            file_path = os.path.join(root, file)
                            try:
                                file_stat = os.stat(file_path)
                                critical_files.append({
                                    'path': file_path,
                                    'size': file_stat.st_size,
                                    'mtime': datetime.fromtimestamp(file_stat.st_mtime).isoformat()
                                })
                            except Exception:
                                pass
                        if len(critical_files) >= 200:  # 限制总文件数量
                            break
                except Exception:
                    pass
        
        return critical_files
    
    def scan_open_ports(self, target='localhost'):
        """扫描开放端口"""
        open_ports = []
        
        try:
            # 使用简单的端口扫描方法
            common_ports = [21, 22, 23, 25, 53, 80, 443, 110, 143, 3306, 3389, 8080]
            
            for port in common_ports:
                try:
                    import socket
                    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                    sock.settimeout(0.5)
                    result = sock.connect_ex((target, port))
                    if result == 0:
                        open_ports.append(port)
                    sock.close()
                except Exception:
                    pass
        except Exception:
            pass
        
        return open_ports
    
    def get_scan_history(self, limit=10):
        """获取扫描历史"""
        return self.scan_history[-limit:]
    
    def generate_report(self, scan_results):
        """生成扫描报告"""
        report = f"""
========================================
VULNERABILITY SCAN REPORT
========================================
Scan Time: {scan_results['timestamp']}
Scan Type: {scan_results['type'].upper()}

"""
        
        if 'system_info' in scan_results:
            report += "SYSTEM INFORMATION\n"
            report += "------------------\n"
            for key, value in scan_results['system_info'].items():
                report += f"{key}: {value}\n"
            report += "\n"
        
        if 'results' in scan_results and scan_results['results']:
            report += "DETECTED VULNERABILITIES\n"
            report += "------------------------\n"
            for vuln in scan_results['results']:
                report += f"CVE: {vuln.get('cve', 'N/A')}\n"
                report += f"Name: {vuln['name']}\n"
                report += f"Severity: {vuln['severity'].upper()}\n"
                report += f"Description: {vuln['description']}\n"
                report += f"Status: {vuln['status']}\n"
                if 'details' in vuln:
                    report += f"Details: {vuln['details']}\n"
                report += "------------------------\n"
        
        report += "SUMMARY\n"
        report += "-------\n"
        for key, value in scan_results['summary'].items():
            if key != 'total':
                report += f"{key.upper()}: {value}\n"
        report += f"TOTAL: {scan_results['summary']['total']}\n"
        
        return report

# 示例用法
if __name__ == "__main__":
    scanner = VulnerabilityScanner()
    
    print("正在扫描系统漏洞...")
    system_results = scanner.scan_system()
    print(scanner.generate_report(system_results))
    
    print("\n正在扫描网络漏洞...")
    network_results = scanner.scan_network('localhost')
    print(scanner.generate_report(network_results))
