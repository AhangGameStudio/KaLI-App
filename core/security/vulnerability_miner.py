# 漏洞挖掘模块
# 实现应用程序静态分析、动态行为监控、敏感权限检测及漏洞识别功能

import os
import re
import subprocess
import json
from datetime import datetime

class VulnerabilityMiner:
    def __init__(self):
        self.static_analyzers = {
            'manifest_analyzer': self.analyze_manifest,
            'code_analyzer': self.analyze_code,
            'resource_analyzer': self.analyze_resources
        }
        
        self.dynamic_monitors = {
            'network_monitor': self.monitor_network,
            'file_monitor': self.monitor_file_access,
            'permission_monitor': self.monitor_permissions
        }
        
        self.vulnerability_patterns = {
            'insecure_http': {
                'pattern': r'http://',
                'description': '使用不安全的HTTP连接',
                'severity': 'high',
                'fix': '使用HTTPS连接'
            },
            'hardcoded_secrets': {
                'pattern': r'(api_key|secret|password|token)\s*[:=]\s*[\'\"]([^\'\"]+)[\'\"]',
                'description': '硬编码的密钥或密码',
                'severity': 'critical',
                'fix': '使用安全的密钥管理方案'
            },
            'insecure_storage': {
                'pattern': r'(SharedPreferences|getSharedPreferences)',
                'description': '使用不安全的存储方式',
                'severity': 'medium',
                'fix': '使用加密存储'
            },
            'dangerous_permissions': {
                'pattern': r'(CAMERA|READ_EXTERNAL_STORAGE|WRITE_EXTERNAL_STORAGE|ACCESS_FINE_LOCATION)',
                'description': '使用危险权限',
                'severity': 'high',
                'fix': '仅在必要时请求权限'
            },
            'webview_security': {
                'pattern': r'(setJavaScriptEnabled|addJavascriptInterface)',
                'description': 'WebView安全配置不当',
                'severity': 'high',
                'fix': '正确配置WebView安全设置'
            }
        }
    
    def analyze_app(self, app_path):
        """分析应用程序漏洞"""
        results = {
            'timestamp': datetime.now().isoformat(),
            'app_path': app_path,
            'static_analysis': {},
            'dynamic_analysis': {},
            'vulnerabilities': [],
            'summary': {
                'total': 0,
                'critical': 0,
                'high': 0,
                'medium': 0,
                'low': 0
            }
        }
        
        # 执行静态分析
        results['static_analysis'] = self.perform_static_analysis(app_path)
        
        # 执行动态分析（模拟）
        results['dynamic_analysis'] = self.perform_dynamic_analysis(app_path)
        
        # 识别漏洞
        results['vulnerabilities'] = self.identify_vulnerabilities(results)
        
        # 生成摘要
        results['summary'] = self.generate_summary(results['vulnerabilities'])
        
        return results
    
    def perform_static_analysis(self, app_path):
        """执行静态分析"""
        static_results = {}
        
        for analyzer_name, analyzer_func in self.static_analyzers.items():
            try:
                static_results[analyzer_name] = analyzer_func(app_path)
            except Exception as e:
                static_results[analyzer_name] = {'error': str(e)}
        
        return static_results
    
    def perform_dynamic_analysis(self, app_path):
        """执行动态分析"""
        dynamic_results = {}
        
        for monitor_name, monitor_func in self.dynamic_monitors.items():
            try:
                dynamic_results[monitor_name] = monitor_func(app_path)
            except Exception as e:
                dynamic_results[monitor_name] = {'error': str(e)}
        
        return dynamic_results
    
    def identify_vulnerabilities(self, analysis_results):
        """识别漏洞"""
        vulnerabilities = []
        
        # 从静态分析结果中识别漏洞
        static_analysis = analysis_results.get('static_analysis', {})
        
        # 分析manifest文件
        manifest_analysis = static_analysis.get('manifest_analyzer', {})
        if 'permissions' in manifest_analysis:
            for permission in manifest_analysis['permissions']:
                if permission in self._dangerous_permissions:
                    vulnerabilities.append({
                        'type': 'dangerous_permissions',
                        'description': f'使用危险权限: {permission}',
                        'severity': 'high',
                        'location': 'AndroidManifest.xml',
                        'fix': '仅在必要时请求权限'
                    })
        
        # 分析代码
        code_analysis = static_analysis.get('code_analyzer', {})
        if 'patterns' in code_analysis:
            for pattern_name, matches in code_analysis['patterns'].items():
                if matches:
                    vuln_info = self.vulnerability_patterns.get(pattern_name, {})
                    for match in matches:
                        vulnerabilities.append({
                            'type': pattern_name,
                            'description': vuln_info.get('description', 'Unknown vulnerability'),
                            'severity': vuln_info.get('severity', 'medium'),
                            'location': match.get('file', 'Unknown'),
                            'line': match.get('line', 0),
                            'match': match.get('match', ''),
                            'fix': vuln_info.get('fix', 'Unknown fix')
                        })
        
        return vulnerabilities
    
    def generate_summary(self, vulnerabilities):
        """生成漏洞摘要"""
        summary = {
            'total': len(vulnerabilities),
            'critical': 0,
            'high': 0,
            'medium': 0,
            'low': 0
        }
        
        for vuln in vulnerabilities:
            severity = vuln.get('severity', 'medium')
            if severity in summary:
                summary[severity] += 1
        
        return summary
    
    def analyze_manifest(self, app_path):
        """分析AndroidManifest.xml文件"""
        results = {
            'permissions': [],
            'activities': [],
            'services': [],
            'receivers': [],
            'providers': []
        }
        
        try:
            manifest_path = os.path.join(app_path, 'AndroidManifest.xml')
            if os.path.exists(manifest_path):
                with open(manifest_path, 'r', encoding='utf-8') as f:
                    manifest_content = f.read()
                
                # 提取权限
                permissions = re.findall(r'<uses-permission[^>]+android:name="([^"]+)"', manifest_content)
                results['permissions'] = permissions
                
                # 提取组件
                results['activities'] = re.findall(r'<activity[^>]+android:name="([^"]+)"', manifest_content)
                results['services'] = re.findall(r'<service[^>]+android:name="([^"]+)"', manifest_content)
                results['receivers'] = re.findall(r'<receiver[^>]+android:name="([^"]+)"', manifest_content)
                results['providers'] = re.findall(r'<provider[^>]+android:name="([^"]+)"', manifest_content)
                
            else:
                results['error'] = 'AndroidManifest.xml not found'
                
        except Exception as e:
            results['error'] = str(e)
        
        return results
    
    def analyze_code(self, app_path):
        """分析应用程序代码"""
        results = {
            'files_scanned': 0,
            'patterns': {}
        }
        
        try:
            # 初始化模式匹配结果
            for pattern_name in self.vulnerability_patterns:
                results['patterns'][pattern_name] = []
            
            # 扫描Java和Kotlin文件
            for root, dirs, files in os.walk(app_path):
                for file in files:
                    if file.endswith(('.java', '.kt')):
                        results['files_scanned'] += 1
                        file_path = os.path.join(root, file)
                        
                        try:
                            with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                                content = f.read()
                            
                            # 匹配漏洞模式
                            for pattern_name, pattern_info in self.vulnerability_patterns.items():
                                pattern = pattern_info['pattern']
                                matches = re.finditer(pattern, content, re.MULTILINE)
                                
                                for match in matches:
                                    line_number = content[:match.start()].count('\n') + 1
                                    results['patterns'][pattern_name].append({
                                        'file': file_path,
                                        'line': line_number,
                                        'match': match.group(0)[:100]  # 只取前100个字符
                                    })
                                    
                        except Exception:
                            pass
        
        except Exception as e:
            results['error'] = str(e)
        
        return results
    
    def analyze_resources(self, app_path):
        """分析应用程序资源"""
        results = {
            'resources': {},
            'assets': []
        }
        
        try:
            # 分析资源目录
            res_dir = os.path.join(app_path, 'res')
            if os.path.exists(res_dir):
                results['resources']['res_dir'] = os.listdir(res_dir)
            
            # 分析资产目录
            assets_dir = os.path.join(app_path, 'assets')
            if os.path.exists(assets_dir):
                for root, dirs, files in os.walk(assets_dir):
                    for file in files:
                        results['assets'].append(os.path.join(root, file))
        
        except Exception as e:
            results['error'] = str(e)
        
        return results
    
    def monitor_network(self, app_path):
        """监控网络行为"""
        # 模拟网络监控结果
        return {
            'connections': [
                {'ip': '192.168.1.1', 'port': 80, 'protocol': 'HTTP', 'risk': 'low'},
                {'ip': '10.0.0.1', 'port': 443, 'protocol': 'HTTPS', 'risk': 'none'}
            ],
            'suspicious_connections': []
        }
    
    def monitor_file_access(self, app_path):
        """监控文件访问"""
        # 模拟文件访问监控结果
        return {
            'files_accessed': [
                {'path': '/data/data/com.example.app/shared_prefs/', 'risk': 'medium'},
                {'path': '/sdcard/Download/', 'risk': 'high'}
            ],
            'suspicious_access': []
        }
    
    def monitor_permissions(self, app_path):
        """监控权限使用"""
        # 模拟权限监控结果
        return {
            'permissions_used': [
                {'permission': 'ACCESS_FINE_LOCATION', 'risk': 'high'},
                {'permission': 'INTERNET', 'risk': 'low'}
            ],
            'suspicious_permissions': []
        }
    
    @property
    def _dangerous_permissions(self):
        """危险权限列表"""
        return [
            'CAMERA',
            'READ_EXTERNAL_STORAGE',
            'WRITE_EXTERNAL_STORAGE',
            'ACCESS_FINE_LOCATION',
            'ACCESS_COARSE_LOCATION',
            'RECORD_AUDIO',
            'READ_CONTACTS',
            'WRITE_CONTACTS',
            'READ_SMS',
            'SEND_SMS',
            'CALL_PHONE',
            'READ_PHONE_STATE'
        ]
    
    def generate_report(self, analysis_results):
        """生成分析报告"""
        report = f"""
========================================
VULNERABILITY MINING REPORT
========================================
Report Time: {analysis_results['timestamp']}
App Path: {analysis_results['app_path']}

STATIC ANALYSIS RESULTS:
------------------------
"""
        
        static = analysis_results['static_analysis']
        for analyzer, result in static.items():
            report += f"{analyzer.replace('_', ' ').title()}:\n"
            if isinstance(result, dict):
                for key, value in result.items():
                    if key != 'error':
                        if isinstance(value, list):
                            report += f"  {key}: {len(value)} items\n"
                        else:
                            report += f"  {key}: {value}\n"
                    else:
                        report += f"  Error: {value}\n"
            report += "\n"
        
        report += "DYNAMIC ANALYSIS RESULTS:\n"
        report += "------------------------\n"
        dynamic = analysis_results['dynamic_analysis']
        for monitor, result in dynamic.items():
            report += f"{monitor.replace('_', ' ').title()}:\n"
            if isinstance(result, dict):
                for key, value in result.items():
                    if key != 'error':
                        if isinstance(value, list):
                            report += f"  {key}: {len(value)} items\n"
                        else:
                            report += f"  {key}: {value}\n"
                    else:
                        report += f"  Error: {value}\n"
            report += "\n"
        
        report += "IDENTIFIED VULNERABILITIES:\n"
        report += "---------------------------\n"
        vulnerabilities = analysis_results['vulnerabilities']
        if vulnerabilities:
            for i, vuln in enumerate(vulnerabilities, 1):
                report += f"{i}. [{vuln['severity'].upper()}] {vuln['description']}\n"
                report += f"   Location: {vuln.get('location', 'Unknown')}\n"
                if 'line' in vuln:
                    report += f"   Line: {vuln['line']}\n"
                if 'match' in vuln:
                    report += f"   Match: {vuln['match']}\n"
                report += f"   Fix: {vuln.get('fix', 'Unknown')}\n"
                report += "\n"
        else:
            report += "No vulnerabilities identified.\n\n"
        
        report += "SUMMARY:\n"
        report += "--------\n"
        summary = analysis_results['summary']
        report += f"Total vulnerabilities: {summary['total']}\n"
        report += f"Critical: {summary['critical']}\n"
        report += f"High: {summary['high']}\n"
        report += f"Medium: {summary['medium']}\n"
        report += f"Low: {summary['low']}\n"
        
        return report

# 示例用法
if __name__ == "__main__":
    miner = VulnerabilityMiner()
    
    # 分析示例应用
    test_app_path = "."  # 当前目录作为示例
    results = miner.analyze_app(test_app_path)
    
    # 生成报告
    report = miner.generate_report(results)
    print(report)
